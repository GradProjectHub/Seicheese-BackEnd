# レートリミット設定
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# IP制限（必要に応じて）
geo $allowed_ip {
    default 0;
    127.0.0.1/32 1;  # localhost
    # 追加のIP範囲
    192.168.1.0/24 1;  # 社内ネットワーク例
}

# Basic認証設定（開発環境用）
auth_basic_user_file /etc/nginx/.htpasswd;

server {
    # ... 既存の設定 ...

    # レートリミットの適用
    limit_req zone=api_limit burst=20 nodelay;
    limit_conn addr 10;

    # 特定のパスに対する制限
    location /admin {
        # IPベースのアクセス制限
        if ($allowed_ip = 0) {
            return 403;
        }
        
        # Basic認証
        auth_basic "Restricted Area";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        proxy_pass http://backend;
    }

    # DoS対策
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 5s 5s;
    send_timeout 10s;
} 